module tests.evolution_chain @ 1.0.0

// Base type
pub gen EntityV1 {
    has id: UInt32
    has name: string
}

// First evo - add fields
evolves EntityV1 > EntityV2 @ 2.0.0 {
    added created_at: Int64 = 0
    added updated_at: Int64 = 0

    migrate from EntityV1 {
        return EntityV2 {
            ...old,
            created_at: 0,
            updated_at: 0
        }
    }
}

// Second evo - change types
evolves EntityV2 > EntityV3 @ 3.0.0 {
    changed id: UInt32 -> UInt64
    added metadata: Map<string, string>
    removed updated_at

    migrate from EntityV2 {
        return EntityV3 {
            id: old.id as UInt64,
            name: old.name,
            created_at: old.created_at,
            metadata: Map.new()
        }
    }
}

// Third evo - rename fields
evolves EntityV3 > EntityV4 @ 4.0.0 {
    renamed name -> display_name
    added tags: Vec<string> = []

    migrate from EntityV3 {
        return EntityV4 {
            id: old.id,
            display_name: old.name,
            created_at: old.created_at,
            metadata: old.metadata,
            tags: []
        }
    }
}

// Geological time evo (biology-style)
pub gen Prokaryote {
    has dna_length: UInt64
    has cell_wall: bool = true
}

evolves Prokaryote > Eukaryote @ 2.0Gya {
    added nucleus: bool = true
    added mitochondria: UInt64 = 1
    added cell_size: Float64 = 10.0

    migrate from Prokaryote {
        return Eukaryote {
            ...old,
            nucleus: true,
            mitochondria: 1,
            cell_size: 10.0
        }
    }

    docs {
        Endosymbiotic origin of eukaryotes, ~2 billion years ago.
    }
}

evolves Eukaryote > Multicellular @ 600Mya {
    added cell_count: UInt64 = 2
    added differentiation: bool = false

    migrate from Eukaryote {
        return Multicellular {
            ...old,
            cell_count: 2,
            differentiation: false
        }
    }
}

docs {
    Tests for evo chains with various change types.
}
