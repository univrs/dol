{{! Handlebars template for Automerge-backed Gen structs }}
//! Generated by DOL Automerge Codegen
//! Source: {{source_file}}

use automerge::Automerge;
use autosurgeon::{Hydrate, Reconcile, ReconcileError, HydrateError};

{{#if includes_sets}}
use std::collections::HashSet;
{{/if}}
{{#if includes_maps}}
use std::collections::HashMap;
{{/if}}

/// {{doc_comment}}
#[derive(Debug, Clone, Reconcile, Hydrate{{#if serde}}, serde::Serialize, serde::Deserialize{{/if}})]
pub struct {{struct_name}} {
{{#each fields}}
    {{#if crdt_attribute}}
    #[autosurgeon({{crdt_attribute}})]
    {{/if}}
    pub {{field_name}}: {{field_type}},
{{/each}}
}

impl {{struct_name}} {
    /// Create a new instance with default values
    pub fn new({{#each fields}}{{field_name}}: {{field_type}}{{#unless @last}}, {{/unless}}{{/each}}) -> Self {
        Self {
            {{#each fields}}
            {{field_name}},
            {{/each}}
        }
    }

    /// Merge changes from another instance using CRDT semantics
    pub fn merge(&mut self, other: &Self) -> Result<(), ReconcileError> {
        autosurgeon::reconcile(self, other)
    }

    /// Create from an Automerge document
    pub fn from_automerge(doc: &Automerge) -> Result<Self, HydrateError> {
        autosurgeon::hydrate(doc)
    }

    /// Convert to an Automerge document
    pub fn to_automerge(&self) -> Result<Automerge, ReconcileError> {
        let mut doc = Automerge::new();
        autosurgeon::reconcile(&mut doc, self)?;
        Ok(doc)
    }
}
